name: Build and deploy Python app to Azure Web App - inventory1

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DJANGO_SETTINGS_MODULE: LG.deployment
  PYTHONUNBUFFERED: 1

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run linters / tests (optional)
        run: |
          echo "Skipping tests (none configured)"

      - name: Collect static (local check)
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_SSLMODE: ${{ secrets.DB_SSLMODE }}
          ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
        run: |
          python manage.py collectstatic --noinput || echo "collectstatic failed or skipped"

      - name: Create file list for inspection
        run: |
          echo "==== FILE LIST ====" > file-list.txt
          echo "" >> file-list.txt
          echo "Top-level files:" >> file-list.txt
          ls -la >> file-list.txt
          echo "" >> file-list.txt
          echo "All files (recursive):" >> file-list.txt
          find . -maxdepth 4 -type f -not -path "./antenv/*" -print >> file-list.txt

      - name: Upload repo file-list artifact
        uses: actions/upload-artifact@v4
        with:
          name: repo-file-list
          path: file-list.txt

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: repo-file-list
          path: .

      - name: Checkout repo (again for deploy)
        uses: actions/checkout@v4

      - name: Set up Python (deploy)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies (deploy)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare environment variables for Django
        run: |
          echo "DJANGO_SETTINGS_MODULE=${{ env.DJANGO_SETTINGS_MODULE }}" >> $GITHUB_ENV
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> $GITHUB_ENV
          echo "DB_SSLMODE=${{ secrets.DB_SSLMODE }}" >> $GITHUB_ENV
          echo "ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}" >> $GITHUB_ENV

      - name: Sanitize DB_SSLMODE and set PGSSLMODE
        run: |
          val="${DB_SSLMODE:-}"
          case "$val" in
            disable|allow|prefer|require|verify-ca|verify-full)
              echo "DB_SSLMODE=$val" >> $GITHUB_ENV
              echo "PGSSLMODE=$val" >> $GITHUB_ENV
              ;;
            ""|\*\*\*)
              echo "DB_SSLMODE=require" >> $GITHUB_ENV
              echo "PGSSLMODE=require" >> $GITHUB_ENV
              ;;
            *)
              echo "DB_SSLMODE=require" >> $GITHUB_ENV
              echo "PGSSLMODE=require" >> $GITHUB_ENV
              ;;
          esac

      - name: Make migrations (safe)
        env:
          DJANGO_SETTINGS_MODULE: ${{ env.DJANGO_SETTINGS_MODULE }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          python manage.py makemigrations --noinput || echo "no migrations to create"

      - name: Run migrations (retry until DB ready)
        env:
          DJANGO_SETTINGS_MODULE: ${{ env.DJANGO_SETTINGS_MODULE }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          set -e
          n=0
          until [ $n -ge 10 ]
          do
            python manage.py migrate --noinput && break
            n=$((n+1))
            echo "migrate failed - retry $n/10, sleeping 15s..."
            sleep 15
          done
          if [ $n -ge 10 ]; then
            echo "migrate did not succeed after retries" >&2
            exit 1
          fi

      - name: Collect static (deploy)
        env:
          DJANGO_SETTINGS_MODULE: ${{ env.DJANGO_SETTINGS_MODULE }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          python manage.py collectstatic --noinput

      - name: List deployed files (sanity)
        run: |
          echo "==== Deployed file list (artifact already created in build job) ===="
          ls -la
          find . -maxdepth 4 -type f | sed -n '1,200p'

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: 'inventory1'
          slot-name: 'production'
          package: '.'

      - name: Show Azure deployment result
        run: |
          echo "Deployment finished. Check Azure Portal Log Stream for runtime logs."
